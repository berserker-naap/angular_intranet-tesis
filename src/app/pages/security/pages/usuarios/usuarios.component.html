<div class="card">
  <div class="flex justify-between items-center mb-3">
    <h2>Usuarios</h2>
    <p-button label="Nuevo Usuario" icon="pi pi-plus" (click)="abrirModal()" />
  </div>

  <p-table [value]="usuarios" [paginator]="true" [rows]="10">
    <ng-template pTemplate="header">
      <tr>
        <th>Login</th>
        <th>Nombre</th>
        <th>Roles</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-usuario>
      <tr>
        <td>{{ usuario.login }}</td>
        <td>{{ usuario.persona?.nombre }} {{ usuario.persona?.apellido }}</td>
        <td>
          <p-tag *ngFor="let rol of usuario.roles" [value]="rol.nombre" class="mr-1" />
        </td>
        <td>
          <p-button icon="pi pi-user-edit" label="Asignar Roles" (click)="abrirAsignarRoles(usuario)" />
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- MODAL CREACIÓN -->
<p-dialog header="Nuevo Usuario" [(visible)]="mostrarModal" [modal]="true" [style]="{ width: '600px' }">
  <form [formGroup]="form" (ngSubmit)="guardar()">
    <div class="field">
      <label>Login</label>
      <input pInputText formControlName="login" />
    </div>

    <div class="field">
      <label>Password</label>
      <input pPassword formControlName="password" toggleMask="true" />
    </div>

    <div class="field">
      <label>
        <input type="checkbox" [(ngModel)]="crearPersona" (change)="togglePersona()" />
        ¿Crear nueva persona?
      </label>
    </div>

    <div *ngIf="crearPersona">
      <div class="field">
        <label>Nombre</label>
        <input pInputText formControlName="persona.nombre" />
      </div>
      <div class="field">
        <label>Apellido</label>
        <input pInputText formControlName="persona.apellido" />
      </div>
    </div>

    <div *ngIf="!crearPersona">
      <label>Persona existente</label>
      <p-dropdown [options]="personas" optionLabel="nombre" optionValue="id" formControlName="idPersona" />
    </div>

    <div class="field">
      <label>Roles</label>
      <p-pickList
        [source]="rolesDisponibles"
        [target]="rolesAsignados"
        optionLabel="nombre"
        sourceHeader="Disponibles"
        targetHeader="Asignados"
        dragdrop="true"
        (onMoveToTarget)="actualizarRoles()"
        (onMoveToSource)="actualizarRoles()"
      ></p-pickList>
    </div>

    <p-footer>
      <p-button label="Cancelar" icon="pi pi-times" (click)="mostrarModal = false" class="p-button-text" />
      <p-button label="Guardar" icon="pi pi-check" type="submit" />
    </p-footer>
  </form>
</p-dialog>

<p-toast position="top-right"></p-toast>
<p-confirmdialog [style]="{ width: '450px' }" />

<app-loading-overlay [loading]="(loading$ | async) ?? false" />
